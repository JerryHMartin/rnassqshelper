---
title: "monthly-county-cotton-yield"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{monthly-county-cotton-yield}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}

# --- Setup ---
library(rnassqshelper)
library(rnassqs)
library(dplyr)
library(tidyr)
library(purrr)
library(tibble)
library(stringr)

# States to query
cotton_states <- c(
  "CALIFORNIA", "ARIZONA", "NEW MEXICO", "OKLAHOMA", "TEXAS",
  "KANSAS", "LOUISIANA", "MISSOURI", "ARKANSAS", "MISSISSIPPI",
  "TENNESSEE", "ALABAMA", "FLORIDA", "NORTH CAROLINA", "GEORGIA",
  "VIRGINIA", "SOUTH CAROLINA"
)

# --- Auth: get/set NASS key ---
api_key <- tryCatch(
  rnassqshelper:::get_nass_key(),
  error = function(e) Sys.getenv("NASS_API_KEY", "")
)
if (!nzchar(api_key)) stop("No NASS_API_KEY found. Add it to .Renviron or use rnassqshelper:::get_nass_key().")
rnassqs::nassqs_auth(key = api_key)

# --- Build grid and fetch using the new wrapper ---
years <- 1970:2025

# Directly call get_nass_yield() with vectors of states and years.
# This returns a single tibble (by default) with all results.
raw_data <- get_nass_yield(
  state      = cotton_states,
  year       = years,
  commodity  = "COTTON",
  statistic  = "YIELD",
  agg_level  = "COUNTY",
  freq       = "MONTHLY",
  sleep      = 0.25
  # If you want a base data.frame instead of a tibble:
  # as_tibble = FALSE
)

# Quick peek
message("Total rows fetched: ", nrow(raw_data))
print(utils::head(raw_data))

# --- Normalize names and clean text ---
normalize_names <- function(df) {
  nms <- tolower(names(df))
  nms <- gsub("[^a-z0-9]+", "_", nms)   # spaces/slashes -> underscore
  names(df) <- nms
  df
}

cleaned <- raw_data |>
  normalize_names() |>
  dplyr::mutate(across(where(is.character), ~ trimws(.x)))


```
